<html>
    <head>
        <meta charset="UTF-8">
        <title>LERNRaumANZeiger</title>
        <script src="js/jquery.js"></script>
        <script src="js/d3.min.js"></script>
        <script src="js/epoch.min.js"></script>
        <script src="js/moment-with-locales.min.js"></script>
        <link rel="stylesheet" type="text/css" href="css/style.css">
        <link rel="stylesheet" type="text/css" href="css/epoch.min.css">
        <style>
h2 {
    display: inline;
    margin-right: 10px;
}
span.notes {
    font-family: monospace;
    margin-left: 10px;
}
table{
    border-spacing: 15px 0;
}
.centeredText{
    text-align: center;
}
        </style>
        <script>

function isRoomOpen(elem){
    var now = new Date();
    if(now.getDay==0)day=elem.sunday;
    else if(now.getDay==6)day=elem.sunday;
    else day=elem.workdays;
    open=day.open;
    close=day.close;
    nextDay = 0;
    if(open==close)return 0;
    if(close<open){nextDay=1};
    minDate = new Date((now.getMonth() + 1) + " " + now.getDate() + ", " + now.getFullYear() + " " + open + ":00");
    maxDate = new Date((now.getMonth() + 1) + " " + (now.getDate()+nextDay) + ", " + now.getFullYear() + " " + close + ":00");
    if(now.getTime() < minDate.getTime()) return -1;
    if(now.getTime() > maxDate.getTime()) return -1;
    console.log(now.getDay());
    return maxDate.getTime()-now.getTime();
}
function getTimeString(room){
    if(now.getDay==0)day=elem.sunday;
    else if(now.getDay==6)day=elem.sunday;
    else day=elem.workdays;
    return day.open+'-'+day.close+' Uhr';
}
$(document).ready(function() {
    moment.locale('en', {
        calendar: {
            sameDay: '[Today] HH:mm',
            lastDay: 'ddd HH:mm',
            nextDay: '[Tomorrow] HH:mm',
            lastWeek: 'ddd HH:mm',
            nextWeek: '[next] ddd HH:mm',
            sameElse: 'L HH:mm'
        }
    });
    moment.locale('de', {
        calendar: {
            sameDay: '[heute] HH:mm',
            lastDay: 'ddd HH:mm',
            nextDay: '[morgen] HH:mm',
            lastWeek: 'ddd HH:mm',
            nextWeek: '[nächsten] ddd HH:mm',
            sameElse: 'L HH:mm'
        }
    });
    var getRequests=[];
    var roomsSpec = [];
    $.get('../rooms.json', function(spec) {
        roomsSpec = spec;
        roomsSpec.forEach(function(room,index,array) {
            $('body').append('<h2>' + room.name + '</h2>');
            $('body').append('<span id="current_users_' + room.id + '" class="current_users"/>');
            $('body').append('<span id="notes_' + room.id + '" class="notes" />');
            $('body').append(
                    '<div id="plot_' + room.id + '" style="width: 100%; height: 150px" class="epoch"/>');

            getRequests.push($.get('http://lernranz.de/parsed/' + room.id + '.json', function(roomData) {
                var firstValue = roomData[0].values[0];
                var lastValue = roomData[0].values[roomData[0].values.length - 1];
                $('#current_users_' + room.id).text(lastValue.y + ' WLAN-Nutzer (' + moment(lastValue.x).fromNow() + ')');
                if (room.notes != undefined) {
                    $('#notes_' + room.id).html(room.notes);
                }
                if (room.fullAt != undefined) {
                    array[index].state=lastValue.y/room.fullAt;
                    roomData.push({
                        label: 'max',
                        values: [{x: firstValue.x, y: room.fullAt}, {x: lastValue.x, y: room.fullAt}]
                    });
                }else{
                    array[index].state=666;
                }
                $('#plot_' + room.id).epoch({
                    type: 'line',
                    data: roomData,
                    ticks: {bottom: 7},
                    tickFormats: {bottom: function(d) { return moment(d).calendar(); }},
                    axes: ['left', 'bottom'],
                });
            }));
        });
        $.when.apply($,getRequests).then(function() {
            roomsSpec.sort(function(a,b){
            if(a.state==0)return 1;
            if(b.state==0)return -1;
            return a.state>b.state});
            var list = $('#roomRanks');
            roomsSpec.forEach(function(element) {
                if(element.state!=666){
                    var liClass="";
                    if(element.state>0.75){liClass="veryFull";}
                    else if(element.state>0.5){liClass="full";}
                    else if(element.state!=0){liClass="normal";}
                    restTime = isRoomOpen(element.openTimes);
                    if(restTime>0){
                         restTime = new Date(restTime);
                         timezone=(restTime.getTimezoneOffset())/-60;
                         hours="";
                         minutes="";
                         ;
                         if(restTime.getHours()>timezone){
                             hours=restTime.getHours()-timezone+" h ";
                         }

                         if(restTime.getMinutes()>0){
                             minutes = restTime.getMinutes()+" min";
                         }
                         time=hours+minutes;
                    }else if(restTime==-1){time="bereits geschlossen";}
                    if(restTime!=0){
                    list.append('<tr><td>' + element.name + '</td><td  class ="'+liClass+' centeredText">' + Math.round(element.state*20)*5 + ' % <td>'+getTimeString(element.openTimes)+'</td><td>'+time+'</td><td>'+element.powerPlugs+'</td></tr>');
                    }
                }
            });
        });
    });
});
        </script>
    </head>
    <body>
        <div id="header">
            <div>
                <h1><a href=".">LERNRaumANZeiger</a></h1>
                <span>für Studenten der <a href="https://www.rwth-aachen.de/">RWTH Aachen</span>
            </div>
            <div>
                <a href="https://github.com/lernranz/lernranz">Github</a>
            </div>
            <div>
                Kontakt: <a href="mailto:lernranz@lernranz.de">lernranz@lernranz.de</a><br/>
                <a href="about.html">über diese Seite / about</a>
            </div>
        </div>
        <table id="roomRanks">
            <tr>
                <th>Raumname</th>
                <th>Belegung</th>
                <th>Öffnungszeiten</th>
                <th>Restzeit</th>
                <th>Strom</th>
            </tr>
        </table></br>
    </body>
</html>
